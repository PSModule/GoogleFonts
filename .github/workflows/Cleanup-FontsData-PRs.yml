name: Cleanup-FontsData-PRs

on:
  pull_request:
    branches:
      - main
    types:
      - closed
    paths:
      - 'src/FontsData.json'

permissions: {}

jobs:
  Cleanup-Superseded-PRs:
    name: Cleanup Superseded Font Data PRs
    runs-on: ubuntu-latest
    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    steps:
      - name: Cleanup Superseded PRs
        uses: PSModule/GitHub-Script@0097f3bbe3f413f3b577b9bcc600727b0ca3201a # v1.7.10
        with:
          ClientID: ${{ secrets.GOOGLEFONTS_UPDATER_BOT_CLIENT_ID }}
          PrivateKey: ${{ secrets.GOOGLEFONTS_UPDATER_BOT_PRIVATE_KEY }}
          Script: |
            Connect-GitHubApp -Organization 'PSModule' -Default
            
            Write-Output "Checking for remaining open Auto-Update PRs after merge..."
            $existingPRs = Get-GitHubPullRequest -Owner 'PSModule' -Name 'GoogleFonts' -State 'open' |
                Where-Object { $_.Title -like 'Auto-Update*' }
            
            if ($existingPRs) {
                Write-Output "Found $($existingPRs.Count) existing Auto-Update PR(s) to close."
                foreach ($pr in $existingPRs) {
                    Write-Output "Closing PR #$($pr.Number): $($pr.Title)"
                    
                    # Add a comment explaining the supersedence
                    $comment = @"
            This PR has been superseded by PR #${{ github.event.pull_request.number }} which has been merged.
            
            The font data has been updated in the merged PR. This PR is now obsolete and will be closed automatically.
            "@
                    New-GitHubPullRequestComment -Owner 'PSModule' -Name 'GoogleFonts' -Number $pr.Number -Body $comment
                    
                    # Close the PR
                    Set-GitHubPullRequest -Owner 'PSModule' -Name 'GoogleFonts' -Number $pr.Number -State 'closed'
                    
                    Write-Output "Successfully closed PR #$($pr.Number)"
                }
            } else {
                Write-Output "No remaining open Auto-Update PRs to close."
            }
